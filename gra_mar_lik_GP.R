################################################################################
# Gradient Marginal Likelihood GP
################################################################################

gra_mar_lik_GP <- function(s2,
                           t2,
                           l2,
                           y,
                           DM){
  ##############################################################################
  # Dimensions
  N   <- length(y)
  ##############################################################################
  
  ##############################################################################
  # Gradient
  # Covariance Function
  eD <- exp(- DM / (2 * l2))
  K  <- t2 * eD
  C  <- K + s2 * diag(nrow = N)
  iC <- solve(C)
  Cy <- iC %*% y
  # Derivative s2
  g_s2 <-      - sum(diag(iC)) / 2
  g_s2 <- g_s2 + t(Cy) %*% Cy / 2
  # Derivative t2
  g_t2 <-      - sum(diag(iC %*% eD)) / 2
  g_t2 <- g_t2 + t(Cy) %*% eD %*% Cy /2
  # Derivative t2
  g_l2 <-      - sum(diag(iC %*% (K * DM / (2 * l2^2)))) / 2
  g_l2 <- g_l2 + t(Cy) %*% (K * DM / (2 * l2^2)) %*% Cy / 2
  ##############################################################################
  
  ##############################################################################
  # Returns Values
  return(c(g_s2, g_t2, g_l2))
}