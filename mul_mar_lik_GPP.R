################################################################################
# Marginal Likelihood Gaussian Predictive Process
################################################################################

mul_mar_lik_GPP <- function(s2,
                            t2,
                            l2,
                            y,
                            Dkk,
                            Dks){
  ##############################################################################
  # Dimensions
  # Number of Observations
  N  <- dim(y)[1]
  KK <- dim(y)[2]
  ##############################################################################
  
  ##############################################################################
  # Auxiliary Variables
  # Covariances
  Ckk <- t2 * exp(- Dkk / l2)
  Cks <- t2 * exp(- Dks / l2)
  K   <- Ckk + Cks %*% t(Cks) / s2
  eK  <- eigen(K)
  Cy  <- Cks %*% y
  # Loglikelihood
  log <-     - KK * N * log(2 * pi) / 2
  log <- log - KK * (sum(log(eK$values)) + N * log(s2) - log(det(Ckk))) / 2
  log <- log - sum(y^2) / (2 * s2)
  for(k in 1:KK){
    # log <- log - t(y[,k]) %*% y[,k] / (2 * s2)
    log <- log + t(Cy[,k]) %*% eK$vectors %*% diag(1 / eK$values) %*% t(eK$vectors) %*% Cy[,k] / (2 * s2^2)
  }
  ##############################################################################
  
  ##############################################################################
  # Returns
  return(log)
  ##############################################################################
  
}